# Проектная работа "Веб-ларек"

Стек: HTML, SCSS, TS, Webpack

Структура проекта:
- `src/` — исходные файлы проекта
- `src/components/` — папка с JS компонентами
- `src/components/base/` — папка с базовым кодом

Важные файлы:
- `src/pages/index.html` — HTML-файл главной страницы
- `src/types/index.ts` — файл с типами
- `src/index.ts` — точка входа приложения
- `src/scss/styles.scss` — корневой файл стилей
- `src/utils/constants.ts` — файл с константами
- `src/utils/utils.ts` — файл с утилитами

## Установка и запуск
Для установки и запуска проекта необходимо выполнить команды

```
npm install
npm run start
```

или

```
yarn
yarn start
```
## Сборка

```
npm run build
```

или

```
yarn build
```
## Данные и типы данных, используемые в приложении

Карточка
```
export interface ICard {
    id: string;
    description: string;
    image: string;
    title: string;
    category: string;
    price: number;
    canBuy: boolean;
    index: number;
}
```
Контакты
```
export interface IContacts {
    email: string;
    phone: string;
}
```
Заказ
```
export interface IOrder {
    payment: string;
    email: string;
}
```
Результат выполнения заказа
```
export interface IOrderResult {
    id: string;
    total: number;
}
```
Интерфейс модели данных карточек в веб-ларьке
```
export interface ICardData {
    list: ICard[];
    selectedCard: string;
}
```
Данные карточки для отображения на главной странице
```
export type TGalleryCard = Pick<ICard, 'image' | 'title' | 'category' | 'price' | 'id'>;
```
Данные карточки используемые в окне с подробной информацией
```
export type TCardModal = Pick<ICard, 'description' | 'image' | 'title' | 'category' | 'price'>;
```
Данные карточки используемые при просмотре корзины
```
export type TBasketCard = Pick<ICard, 'title' | 'price' | 'id' | 'index'>;
```
Данные ордера для выбора способа оплаты
```
export type TPayment = 'card' | 'cash';
```
Данные используемые для валидации форм
```
export type TOrderError = Partial<Pick<IOrder, 'payment' | 'address' | 'email' | 'phone'>>
```
Данные для начальной инициализации
```
export type TInitCards = { total: number, items: ICard[] };
```
Данные для результата размещения ордера
```
export type TOrderResponse = { id: string, total: number }
```

## Архитектура приложения

Кодовая база приложения разделена на слои согласно парадигме MVP

### Базовый код

#### Класс Api
Содержит в себе базовую логику отправки запросов.

*Конструктор :*
- `constructor(baseUrl: string, options: RequestInit = {})` - принимает базовую часть адреса сервера и опционально объект с заголовками запросов.

*Методы :*
- `get` - выполняет GET запрос, параметром принимает endpoint запроса и возвращает promise с объектом которым ответил сервер.
- `post` - параметрами принимает endpoint и объект с данными, которые будут переданы в JSON в теле запроса. По умолчанию выполняется POST запрос, но метод запроса может быть переопределен заданием третьего параметра.
- `handleResponse(response: Response): Promise<object>` - содержит общую для всех методов запроса логику обработки состояния `Promise.reject`.

#### Класс EventEmitter
Брокер событий позволяет подписываться на события и отправлять события. В слоях приложения используется для генерации событий, а в presenter для их обработки.
Основные методы описаны в интерфейсе `IEvents`:
- `on` - подписывает на событие
- `emit` - инициализирует событие
- `trigger` - возвращает функцию при вызове которой инициализируется требуемое событие


### Слой данных

#### Класс CardData 
Отвечает за хранение и логику работы с данными карточек в ларьке полученных с сервера.

*Конструктор :*
- `constructor(protected events: IEvents)` - экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_cards: ICard[]` - массив объектов карточек
- `_selectedCard: string | null` - `id` карточки, выбранного для просмотра в модальном окне.
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

*Методы :*
- `getCard(id: string): ICard` - возвращает карточка по `id`
- а так-же сеттеры и геттеры для сохранения и получения данных из полей класса

#### Класс BasketData
Отвечает за хранение и логику работы с карточками в корзине.

*Конструктор :*
- `constructor(protected events: IEvents)` - экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_basket: IBasket` - корзина.
- `_cardToDelete: string` - id карточки для удаления из корзины.
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

*Методы :*
- `addCard(card: ICard): void` - добавляет один карточка в начало массива и вызывает событие изменения массива.
- `removeCard(id: string): void` - удаляет из массива выбранный карточка по `id` и вызывает событие изменения массива и вызывает событие изменения массива.
- `getCardInfo(): TCardBasket` - получение данных карточки.
- `checkCardStatus(id: string): boolean` - проверяет находится ли выбранный карточка в корзине.
- а так-же сеттеры и геттеры для сохранения и получения данных из полей класса.

#### Класс OrderData
Отвечает за хранение и логику работы с заказом.

*Конструктор :*
- `constructor(protected events: IEvents)` - экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_order: IOrder` - заказ.
- `_orderErrors: TOrderError` - объект для хранения ошибок валидации форм.
- `events: IEvents` - экземпляр класса `EventEmitter` для инициации событий при изменении данных.

*Геттер *
- `order()` - для получения объекта заказа.

*Методы :*
- `setField(field: keyof IOrder, value: string): void` - для заполнения ключей объекта ордере значениями полученными с форм.
- `clear(): void` - прописывает в значения полей ордера пустые строки.
- `getOrderError(): TOrderError` - для получения объекта с ошибками.
- `isOrderValid(): boolean` - проверяет поля ордера заполненные из `OrderView` и используется для блокировки кнопки формы.
- `isContactsValid(): boolean` - проверяет поля ордера заполненные из `ContactsView` и используется для блокировки кнопки формы.
- `validateOrder(): void` - проверяет ключи `_order` на валидность и генерирует ошибки в соответствующие ключи `_orderErrors`.


### Слой представления
Все классы представления отвечают за отображение внутри контейнера (DOM-элемент) передаваемых в них данных.

#### Класс View
Базовый класс представления содержит методы управления DOM-элементами.

*Конструктор :*
- `constructor(protected readonly container: HTMLElement, protected events: IEvents)` - принимает элемент  на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Методы :*
- `setText(element: HTMLElement, value: unknown)` - для установки текстовых данных.
- `emitChanges(event: string, payload?: object)` - для установки событий с соответствующими именами через `events.emit`.
- `setDisabled(element: HTMLElement, state: boolean)` - для управления состоянием блокировки элементов.
- `setImage(element: HTMLImageElement, src: string, alt?: string)` - устанавливает изображение с альтернативным текстом(опционально).
- `toggleClass(element: HTMLElement, className: string, force?: boolean)` - для переключения класса у элемента
- `render(data?: Partial<T>): HTMLElement` - отображает элемент представления.


#### Класс ModalView
Реализует модальное окно. Устанавливает слушатели на клавиатуру, для закрытия модального окна по `Esc`, на клик в оверлей и кнопку-крестик для закрытия модального окна. Генерация событий `modal:open`, `modal:close`. 

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает элемент модального окна на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_closeBtn: HTMLButtonElement` - элемент кнопки закрытия модального окна.
- `_content: HTMLElement` - хранит содержимое модального окна

*Сеттеры :*
- `content(content: HTMLElement)` - размещает контент в модальном окне.

*Методы :*
- `open` и `close` - для управления отображением модального окна и генерации соответствующих событий.
- `render` - отображает модальное окно.
- `handleEscUp(event: KeyboardEvent)` - реализует закрытие модального окна по клавише `Esc`.

#### Класс Form
Компонент формы.

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает элемент формы на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_error: HTMLElement` - для вывода сообщений об ошибках валидации в форме
- `_valid: boolean` - для изменения состояния кнопки `submit`
- `_submitButton: HTMLButtonElement` - для элемента кнопки подтверждения
- `_containerName: string` - хранит имя контейнера

*Сеттеры :*
- `valid(isValid: boolean)` - изменяет активность кнопки подтверждения
- `error(error: string)` - устанавливает текс ошибки в элемент отображения

*Методы :*
- `showInputError(errorMessage: string)` - для вывода ошибки валидации
- `hideInputError()` - для скрытия ошибки валидации.
- `reset()` - для сброса форм.

#### Класс CardView
Отвечает за отображение карточки, задавая в карточке данные названия, описание, изображения, категорию, стоимость товара. Класс используется для отображения карточек на странице сайта. В классе устанавливаются слушатели на все интерактивные элементы, в результате взаимодействия с которыми пользователя генерируются соответствующие события.

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает элемент карточки на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_cardCategory: HTMLSpanElement` - элемент категории товара.
- `_cardTitle: HTMLTitleElement` - элемент заголовка товара.
- `_cardImage: HTMLImageElement` - элемент изображения товара.
- `_cardPrice: HTMLSpanElement` - элемент стоимости товара.
- `_cardText: HTMLParagraphElement` - элемент описания товара.
- `_button: HTMLButtonElement` - элемент кнопка товара
- `_index: HTMLElement` - элемент отображения порядкового номера товара в корзине.
- `_isSelected: boolean` - флаг (карточка в корзине или нет).
- `id: string` - id карточки для передачи в `events.emit`.

*Сеттеры :*
- `category(category: string)` - устанавливает категорию и ее цвет.
- `title(title: string)` - устанавливает заголовок.
- `image(address: string)` - устанавливает изображение.
- `price(price: number)` - устанавливает стоимость товара.
- `description(value: string)` - устанавливает описание товара.
- `index(value: number)` - устанавливает порядковый номер товара в корзине.
- `canBuy(value: boolean)` - устанавливает значение `_isSelected` и в зависимости от него меняет название кнопки карточки на `Удалить`

*Методы :*
- `setColor(category: string): void` - устанавливает цвет на элемент категории товара используя для этого объект `CategoryColor`, путем подстановки ключа (соответствующего значению категории товара полученной от сервера по каждой карточке) в строку генерации селектора стилей отвечающих за цвет.


#### Класс BasketView
Отвечает за отображение корзины. Предоставляет сеттеры для изменения отображения корзины.

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает элемент корзины на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_cards` - элемент содержимого корзины (карточек товаров).
- `_basketItemIndex` - элемент отображения индекса карточки товара в корзине.
- `_cost` - элемент стоимости товаров в корзине.
- `_basketButton` - элемент кнопки оформления заказа в корзине.

*Сеттеры :*
- `cards(cards: HTMLElement[])` - размещает карточки в корзине.
- `cost(cost: number)` - меняет состояние активности кнопки на переданное.

#### Класс OrderView
Реализует компонент формы заказа.

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает элемент формы ордера на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `_orderButtons?: NodeListOf<HTMLButtonElement>` - кнопки выбора типа оплаты.
- `_payment: string` - поле для хранения способа оплаты.

*Сеттеры :*
- `payment(value: string)` - для сброса поля `_payment` и состояния кнопок выбора способа оплаты.
- `address(value: string)` - для установки поля ввода адреса.

#### Класс ContactsView
Реализует компонент формы контактов.

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает элемент формы контактов на основе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Сеттеры :*
- `email(value: string)` - для установки поля ввода с email.
- `phone(value: string)` - для установки поля ввода с телефоном.

#### Класс SuccessView
Отвечает за отображение окна с подтверждением заказа.

*Конструктор :*
- constructor(protected container: HTMLElement, protected events: IEvents)принимает элемент окна на базе шаблона и экземпляр класса `EventEmitter` для возможности инициации событий.

*Поля :*
- `title: string`  - элемент заголовка.
- `description: string` - элемент для указания списанной за ордер суммы.

*Сеттеры :*
- `description(value: string)` - меняет содержимое элемента с суммой заказа.

#### Класс PageView
Отвечает за отображение блока с карточками на главной странице .

*Конструктор :*
- `constructor(protected container: HTMLElement, protected events: IEvents)` - принимает DOM-элемент главной страницы, в котором размещаются карточки и брокер событий.

*Поля :*
- `container: HTMLElement` - элемент контейнера.
- `events: IEvents` - брокер событий.
- `_basket: HTMLElement` - элемент корзины.
- `_basketCount: HTMLElement` - элемент счетчика товаров в корзине.
- `_gallery: HTMLElement` - элемент для отображения списка карточек товаров.
- `_wrapper: HTMLElement` - элемент для переключения возможности прокрутки главной страницы.

*Сеттеры :* 
- `gallery(elements: HTMLElement[])` - для добавления карточек на страницу.
- `count(value: number)` - для установки количества товаров в корзине.
- `locked(value: boolean)` - для включения и отключения прокрутки главной страницы.


### Слой коммуникации

#### Класс LarekApi
Принимает в конструктор `constructor((cdn: string, baseUrl: string, options?: object)` - часть адреса получения изображений карточки, базовый Url и опционально объект с заголовками запросов. Предоставляет методы реализующие взаимодействие с бэкэндом сервиса.

* Методы :*
- `getProductList(): Promise<ICard[]>` - для получения списка продуктов.
- `placeOrder(order: IOrder): Promise<TOrderResponse>` - для отправки сформированного ордера на сервер

### Взаимодействие компонентов
Код, описывающий взаимодействие представления и данных между собой находится в файле `index.ts`, выполняющем роль презентера.\
Взаимодействие осуществляется за счет событий генерируемых с помощью брокера событий и обработчиков этих событий, описанных в `index.ts`\
В `index.ts` сначала создаются экземпляры всех необходимых классов, а затем настраивается обработка событий.

### Список событий, генерируемых в системе:
**События изменения данных (генерируются классами моделями данных)**
- `cards:changed` - изменение массива карточек
- `card:selected` - изменение открываемой в модальном окне карточки
- `card:clear` - очистка данных выбранной для показа в модальном окне карточки

**События, возникающие при взаимодействии пользователя с интерфейсом (генерируются классами, отвечающими за представление)**\
*- События модальных окон*
- `modal:open` - открытие модального окна
- `modal:open` - закрытие модального окна

*- События модального окна просмотра карточки*
- `selected-card:changed` - выбор карточки для просмотра в модальном окне
- `basket: open` - при открытии корзины

*- События модального окна  корзины*
- `card:delete` - выбор карточки для удаления из корзины
- `basket:changed` - изменение количества карточек в корзине

*- События модального окна с формой выбора способа оплаты и адреса*
- `payment:selected`- выбор способа оплаты заказа
- `edit-payment-form:input` - изменение данных в форме способа оплаты
- `edit-payment-form:validation` - сообщает о необходимости валидации формы
- `payment-form:submit` - сохранение данных формы (способ оплаты и адрес)
- `form-input-field:change` - изменение полей ввода

*- События модального окна с формой ввода email и телефона*
- `edit-email-form:input` - изменение данных в форме способа оплаты
- `edit-email-form:validation` - сообщает о необходимости валидации формы
- `email-form:submit` - сохранение данных формы ( email и телефон)

*- События модального окна с формой подтверждения заказа*
- `order-status-form:submit` - генерируемое при нажатии "За новыми покупками"

### Презентер

Отвечает за взаимодействие компонентов Взаимодействие происходит за счет брокера событий, который их отслеживает.